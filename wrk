#!/bin/bash

ARGV="$@"

source ./actions/-head -N "wrk"  -T "Build and deploy" $@



unset OPTIND

while getopts "hcbdDCSJHI" flag; do

  case "${flag}" in
    h) HELP=1 ;;
    c) CLEAR_CONSOLE=1 ;;
    b) BUILD=1 ;;
    d) DEPLOY=1 ;;
    D) DEV=1 ;; # dev mode
  esac
done
shift $((OPTIND - 1))
TMP_NAME=$1 # template name

if [ "$DEV" = "1" ]; then
  BUILD_OPTS="${BUILD_OPTS}D"
  BUILD_DIR="http/$TMP_NAME"
else
  BUILD_OPTS=""
  BUILD_DIR="dist/$TMP_NAME"
fi

TMP_DIR="sites/${TMP_NAME}"
DEPLOY_CONFIG="${TMP_DIR}/deploy.json"

source actions/wrk-actions

# -b (build)
if [ "$BUILD" = "1" ]; then
  node --import=tsx ./src/build.ts $ARGV
fi

# -d (deploy)
if [ "$DEPLOY" = "1" ]; then
  actions/wrk-deploy $DEPLOY_CONFIG $BUILD_DIR $DEV
fi
